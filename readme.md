# 复旦大学2024年秋季学期图数据管理与挖掘期末Project

## 团队成员

- DRZ, LZK

## 背景

- 基于蒙特卡洛模拟和矩阵计算，开发一系列用于图同构检验问题的剪枝算法，在执行具体的同构检查算法（如VF2算法）之前，迅速筛选掉不合理的图。
- 具体的场景可能是：数据库中已有大量已知的图数据（如化学分子式），给定查询图（q），尽可能快速地查找到数据库中所有与q同构的图。数据库中的图为半静态数据，更新较慢，能够通过离线计算的方式挖掘其各类性质用于剪枝。查询图为流式数据，其结构信息难以提前知道。

## 文件目录树

- **请DRZ同学协助完成，将项目文件结构整理成如下目录树**，并保持代码注释风格一致，可参考[utils.py](./utils.py)文件

```
|-- graph-data
    |-- graphs  # 存放图数据，格式为pkl
    |-- image # 存放图片
    |-- .gitignore # git忽略文件，为节省存储空间，忽略pkl和图片文件的更新，因为可以在本地生成
    |-- readme.md # 项目说明文档
    |-- eigenvalue_research.py # 研究不同种类的邻接矩阵特征值分布
    |-- Monte_Carlo_prune.py # 使用蒙特卡洛模拟进行剪枝
    |-- Lancoz_prune.py # 使用Lancoz算法进行剪枝
    |-- Perron_multiplicity_prune.py # 估计Perron根的重数，用于剪枝
    |-- utils.py # 存放工具函数，用于在不同的任务之间共享
```

## 注意事项
- 生成随机图的时候，为了保持 $|E|=O(V)$ 的稀疏性，请将边的生成概率控制在 $p=O(1/|V|)$。
- 请生成 $n>20$ 以上的随机图，以防止出现结构对称的图，如二甲苯。


## 任务目标

- [X] 邻接矩阵特征值性质研究。目前发现带权重、对角元非零（无周期）的邻接矩阵具有较好的特征值性质。此外，行归一化的矩阵（也即马尔可夫转移矩阵）、对称矩阵（对应无向图）也都有较好的特征值性质。以上发现可以为后续的蒙特卡洛模拟、Lancoz算法提供一些启发。
- [ ] 蒙特卡洛模拟
  - 用degree作为权重，**效果很好**，后续优化方向：0权重节点预处理、初始粒子分布改进、尝试使用其他关于degree的函数
  - [ ] 研究扰动边的比例 $k/|E|$ ，和MSE之间的关系，画出折线图。MSE可以通过生成m对非同构图，扰动比例都是 $k/|E|$ ，计算m对图之间稳态的差异，再取平均值而得到。
  - [ ] 研究图节点数 $n$ 与最低粒子数（最低粒子数，也即稳态分布能够达到预期剪枝效果的最少粒子数量，如使F1值达到70%）的关系，画出折线图。
  - [ ] 除了MSE，也可以考虑用JS散度，或者Wasserstein距离等其他概率上常用的benchmark来度量两个归一化向量的距离。
  - [ ] （若无时间该项可留到1月3日后做）用Logistic回归寻找具有最优区分度的Threshold。Threshold可能会随着图的维度 $n$ 、扰动边的比例 $k/|E|$ 等因素变化，需要较精细的统计分析。
- [ ] 带深度BFS
  - 一次图遍历：计算所有节点度数 二次图遍历：从所有度数为k（可任意指定）的节点同时开始进行BFS，得到所有节点BFS深度与度数组合
  - 若两张图的BFS深度与度数组合的集合不同则一定不同构（可能需要证明），若集合相同则很可能同构
  - 可取不同的k进行重复验证，多次剪枝，提高准确率
  - k取最大度数时效果较好，在大图中将不同构图判断为同构的概率极低
- [ ] Lancoz算法：可以很好地利用矩阵的稀疏性来加快计算。前期数值实验表明对称的、且对角线非零（相当于马尔科夫链无周期）的矩阵的特征值不容易出现重根，因此Lancoz算法结合Cauchy交错定理，应该也会有很好的剪枝效果。
- [ ] Perron根重数估计。来自邵美悦老师的一个建议。前期数值实验发现，带权重的、行归一化的邻接矩阵没有虚数根，而且Perron根（也即最大的特征根，为1）的重数往往比较高。Perron根的重数也可以用于剪枝。例如，做一个在1附近的围道积分用以估计Perron根代数重数的上界：

$$
\text{tr} \left(\frac{1}{2\pi\text{i}}\int_{\Gamma}1(\lambda I- A)^{-1} \text{d}\lambda\right)
$$

- （若时间充足可研究该问题）结构对称图的剪枝。可供考虑的方案有：
  - 尝试对图进行折叠以消除对称性，但找到对称轴并不容易。
  - 随机生成大图，这样不容易出现结构对称图
  - 融合部分已有节点形成超节点或增加伪节点，以破坏对称性（但需要对目标图也进行相应的修改，很难）
  - 对周期性波动的稳态进行sorting（部分场合下效果还不错，有挖掘潜力）
  - 随机生成初始状态（似乎效果不好）

## 后续任务

- [ ] Presentation准备（PPT制作、试讲），1月3日汇报
- [ ] 期末英文报告撰写，1月10日前提交

## 项目日志

- 2024.12.25 完成邻接矩阵特征值探索性实验。
- 2024.12.25 线下讨论，确定了尝试Perron根重数、蒙特卡洛模拟、Lancoz算法三种剪枝方式。对蒙特卡洛权重设置问题、相近图的蒙特卡洛粒子分布差异的度量问题、项目代码结构等进行了讨论。
- 2024.12.25 开始蒙特卡洛模拟实验，为蒙特卡洛模拟添加提前终止条件：粒子分布sort后归一化MSE小于阈值。开始模拟后，首先所有节点不设置权重，对相似无向图区分能力很差，对相似有向图，k=5时粒子分布出现一定差异，但MSE并无明确阈值。后发现权重可设置为：无向图 $d^2$ ,有向图 $d_{\text{入}} \cdot d_{\text{出}}$ 。灵感为经过节点的局部路径数量。对相似无向图（邻二甲苯、间二甲苯、对二甲苯解构）进行模拟，粒子分布差异明显。对相似有向图进行模拟，粒子分布差异观察可得，效果明显。
- 2024.12.26 项目文件目录树重构。
- 2024.12.28 修改随机矩阵生成器，使之以degree作为权重，与蒙特卡洛模拟保持一致。
- 2024.12.28 讨论蒙特卡洛剪枝算法。确定了三项主要的统计学可视化分析：扰动量 $(k/|E|)$ 与MSE关系，graph维度与最少粒子数量关系（最少粒子指其稳态能够产生区分度的最小粒子数量），以及不同类型的阈值（MSE，JS，Wasserstein）的最佳Threshold随扰动量的变化。此外重点研究了二甲苯的转移矩阵 $P$ 的性质，发现粒子容易陷入 $P^2$ 的稳态，且证明了结构对称图的转移矩阵 $P$ 必有-1的特征根。考虑方案包括：**随机生成大图（不容易出现结构对称图），增加伪节点破坏对称性，对周期性波动的稳态进行sorting，随机生成初始状态**。
- 2024.12.30 优化同构或相似矩阵对的生成逻辑
- 2024.12.30 实践蒙特卡洛剪枝算法，发现在归一化mse、js散度、Wasserstein距离的多重验证下准确率更高，讨论分类器和Threshold的设置
- 2024.12.30 确定新方法，带深度BFS。具体流程——一次图遍历：计算所有节点度数；二次图遍历：从所有度数为k（可任意指定）的节点同时开始进行BFS，得到所有节点BFS深度与度数组合。若两张图的BFS深度与度数组合的集合不同则一定不同构（可能需要证明），若集合相同则很可能同构。可取不同的k进行重复验证，多次剪枝，提高准确率。k取最大度数时效果较好，在大图中将不同构图判断为同构的概率极低。
